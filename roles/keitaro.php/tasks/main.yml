---
- name: Install scl repo
  yum:
    name: centos-release-scl
    state: latest

- name: Install php extensions
  yum:
    name:
      - "{{php_version}}"
      - "{{php_version}}-php-fpm"
      - "{{php_version}}-php-bcmath"
      - "{{php_version}}-php-devel"
      - "{{php_version}}-php-mysqlnd"
      - "{{php_version}}-php-opcache"
      - "{{php_version}}-php-pecl-redis"
      - "{{php_version}}-php-mbstring"
      - "{{php_version}}-php-pear"
      - "{{php_version}}-php-xml"
      - "{{php_version}}-php-pecl-zip"
      - "{{php_version}}-php-ioncube-loader"
    state: installed

- name: Link php directories and binary
  file:
    src: "{{item.from}}"
    dest: "{{item.to}}"
    state: link
  with_items:
    - {from: "/usr/bin/{{php_version}}", to: '/usr/bin/php'}
    - {from: "/opt/remi/{{php_version}}/root/bin/php-config", to: '/usr/bin/php-config'}
    - {from: "/etc/opt/remi/{{php_version}}", to: '/etc/php'}
    - {from: "/var/opt/remi/{{php_version}}/log/php-fpm/", to: '/var/log/php-fpm'}

- name: Make php-fpm service extra configuration dir
  file:
    path: "/etc/systemd/system/{{ php_version }}-php-fpm.service.d"
    state: directory

- name: Set opened files limit
  template:
    src: set_limits.conf
    dest: "/etc/systemd/system/{{ php_version }}-php-fpm.service.d/set_limits.conf"
  notify:
    - reconfigure nginx

- name: Increase limits
  lineinfile:
    path: /etc/php/php.ini
    regexp: '^{{ item.key }}'
    line: '{{ item.key }} = {{ item.value }}'
  with_dict:
    memory_limit: '{{ php_memory_limit }}'
    post_max_size: '{{ php_max_upload_size }}'
    upload_max_filesize: '{{ php_max_upload_size }}'
    short_open_tag: 'On'
  notify:
    - restart php-fpm

- name: Generate a pool config
  template:
    src: "www.conf.j2"
    dest: "/etc/php/php-fpm.d/www.conf"
    owner: root
    group: root
    mode: 0644
  notify:
    - restart php-fpm

- name: Run php-fpm
  service:
    name="{{php_version}}-php-fpm"
    state=started
    enabled=yes
