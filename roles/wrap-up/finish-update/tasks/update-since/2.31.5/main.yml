- name: Remove old nginx files
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /etc/nginx/conf.d/keitaro/admin.inc
    - /etc/nginx/conf.d/keitaro/locations-common.inc
    - /etc/nginx/conf.d/keitaro/locations-tracker.inc
    - /etc/nginx/conf.d/keitaro/nontracker.inc
    - /etc/nginx/conf.d/keitaro/nontracker.php-fpm.inc
    - /etc/opt/remi/php74/php-fpm.d/keitaro-nontracker.conf

- name: Change configs genereated by enable-ssl
  shell: >-
    set -o pipefail && \
    grep -l 'root {{ keitaro_app_dir }}' *.conf | \
    xargs sed -i -r -e '/locations-common/a \  include /etc/nginx/conf.d/keitaro/locations/1-common.inc;' \
                    -e '/locations-common/a \  include /etc/nginx/conf.d/keitaro/locations/2-www.inc;' \
                    -e '/locations-common/a \  include /etc/nginx/conf.d/keitaro/locations/3-admin.inc;' \
                    -e '/locations-common/a \  include /etc/nginx/conf.d/keitaro/locations/4-tracker.inc;' \
                    -e '/locations-common/d' \
                    -e '/locations-tracker/d'
  args:
    chdir: /etc/nginx/conf.d
  register: change_nginx_site_configs
  # grep will fail with 1 error code if there are no matches, so rc == 1 is ok
  failed_when: change_nginx_site_configs.rc != 0 and change_nginx_site_configs.rc != 1
  changed_when: false
