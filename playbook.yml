---
- hosts: all
  connection: "{{connection}}"
  become: yes
  become_method: sudo
  vars_files:
    - vars/keitaro.yml
    - vars/server.yml
    - vars/ssl.yml
    - vars/mariadb.yml
    - vars/nginx.yml
    - vars/php.yml
    - "vars/performance.{{ php_engine }}.yml"
    - vars/performance.yml

  roles:
    - {role: 'init/0-debug', tags: 'upgrade, tune'}
    - {role: 'init/1-prepare-upgrade', tags: 'never, upgrade, prepare-upgrade'}
    - {role: 'init/create-tracker-user-and-dirs', tags: 'init, create-tracker-user-and-dirs'}
    - {role: 'init/disable-ipv6', tags: 'init, disable-ipv6'}
    - {role: 'init/enable-swap', tags: 'init, enable-swap'}
    - {role: 'init/enable-repo-remi', tags: 'init, enable-repo-remi'}
    - {role: 'init/enable-firewall', tags: 'init, enable-firewall', when: "skip_firewall is not defined or skip_firewall != 'yes'"}
    - {role: 'init/increase-max-opened-files', tags: 'init, increase-max-opened-files'}
    - {role: 'init/install-certbot', tags: 'init, install-certbot'}
    - {role: 'init/install-kctl-tools', tags: 'init, install-kctl-tools'}
    - {role: 'init/install-packages', tags: 'init, install-packages'}
    - {role: 'init/setup-certs', tags: 'init, setup-certs'}
    - {role: 'resmo.ntp', tags: 'ntp'}
    - {role: 'mrlesmithjr.timezone'}
    - {role: 'keitaro.systemd', tags: 'systemd, upgrade'}
    - {role: 'keitaro.disable_thp', tags: 'mariadb, tokudb, redis, upgrade'}
    - {role: 'keitaro.postfix', tags: 'mail, upgrade'}
    - {role: 'redis/1-install', tags: 'redis'}
    - {role: 'redis/2-tune', tags: 'redis, tune, redis-tune, upgrade'}
    - {role: 'mariadb/0-prepare-upgrade', tags: 'never, upgrade'}
    - {role: 'mariadb/1-install', tags: 'mariadb, upgrade'}
    - {role: 'mariadb/2-tokudb', tags: 'mariadb, tokudb, upgrade'}
    - {role: 'mariadb/3-tune', tags: 'mariadb, tokudb, tune, mariadb-tune, upgrade'}
    - {role: 'nginx/1-install', tags: 'nginx, upgrade'}
    - {role: 'nginx/2-tune', tags: 'nginx, tune, nginx-tune'}
    - {role: 'nginx/3-upgrade', tags: 'never, upgrade'}
    - {role: 'php/php/1-install', tags: 'php, upgrade'}
    - {role: 'php/php/2-tune', tags: 'php, upgrade'}
    - {role: 'php/php-fpm/1-install', tags: 'php, php-fpm, upgrade'}
    - {role: 'php/php-fpm/2-tune', tags: 'php, php-fpm, tune, php-fpm-tune, upgrade'}
    - {role: 'php/php-fpm/3-upgrade', tags: 'never, upgrade, php-fpm-upgrade'}
    - {role: 'php/roadrunner/1-install', tags: 'php, roadrunner, upgrade'}
    - {role: 'php/roadrunner/2-tune', tags: 'php, roadrunner, tune, roadrunner-tune, upgrade'}
    - {role: 'tracker/1-install', tags: 'tracker, tracker-install'}
    - {role: 'tracker/2-tune', tags: 'tracker, tune, tracker-tune, upgrade'}
    - {role: 'tracker/3-upgrade', tags: 'never, upgrade'}
    - {role: 'tracker/4-restore-db', tags: 'db_restore', when: "db_restore_path is defined and db_restore_path != ''"}

