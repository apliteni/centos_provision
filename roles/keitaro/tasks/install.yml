---
- name: Download installer
  get_url:
    url: "https://keitaro.io/getfile/install"
    dest: "{{ keitaro.path }}/install.php"

- name: Install Keitaro
  tags: keitaro
  command: |
      /usr/bin/php install.php install --ip={{ license_ip }} \
                                       --key={{ license_key }} \
                                       --db-user="{{ db_user }}" \
                                       --db-name="{{ db_name }}" \
                                       --db-password="{{ db_password }}" \
                                       --admin-login="{{ admin_login }}" \
                                       --admin-password="{{ admin_password }}" \
                                       --draft-storage=redis \
                                       --cache-storage=files \
                                       --force-tokudb \
                                       {% if language is defined %}--language={{ language }}{% endif %} \
                                       {% if kversion is defined %}--kversion={{ kversion }}{% endif %}
  args:
    chdir: "{{ keitaro.path }}"
    creates: "{{ keitaro.path }}/var/install.lock"
  become_user: "{{ os_user }}"
  register: command_result
  failed_when: "'Installation Finished' not in command_result.stdout and 'Установка завершена' not in command_result.stdout"

- name: Configure cron to run keitaro task every minute
  cron:
    user: "{{os_user}}"
    name: "keitaro"
    job: "php {{ keitaro.path }}/cron.php"

- name: Configure cron to update geo databases every week
  cron:
    user: "{{os_user}}"
    name: "update geodbs"
    weekday: "{{ 7 | random }}"
    hour: "{{ 24 | random }}"
    minute: "{{ 60 | random }}"
    job: "php {{ keitaro.path }}/bin/cli.php geodbs:update_all"
