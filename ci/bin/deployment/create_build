#!/usr/bin/env bash
set -e -x -o pipefail

source ci/bin/lib/ensure_variables_are_set.sh

ensure_variables_are_set LOCAL_BUILD_PATH DEPLOY_TO

rm -rf "${LOCAL_BUILD_PATH}"

mkdir -p "${LOCAL_BUILD_PATH}"

sed -i "s:releases/stable:$DEPLOY_TO:g" scripts/install.sh vars/keitaro.yml

cp scripts/{install,add-site,enable-ssl,delete-ssl}.sh RELEASE_VERSION "${LOCAL_BUILD_PATH}"

tar -zcvf "${LOCAL_BUILD_PATH}/playbook.tar.gz" playbook.yml ansible.cfg roles vars RELEASE_VERSION
