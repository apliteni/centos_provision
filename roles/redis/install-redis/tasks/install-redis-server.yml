- name: Set clickhouse_uid
  set_fact:
    redis_user_id: "{{ redis_user_info.uid }}"
    redis_group_id: "{{ redis_user_info.group }}"

- name: Set podman command for Centos 7
  set_fact:
    podman_command: "/usr/bin/podman rm --force {{ redis_docker_name }} && /usr/bin/podman rm --force --storage {{ redis_docker_name }}"
  when: ansible_distribution_major_version | int == 7

- name: Set podman command for Centos above 7
  set_fact:
    podman_command: "/usr/bin/podman rm --force --storage {{ redis_docker_name }}"
  when: ansible_distribution_major_version | int > 7

- name: Pull image
  shell: source /etc/keitaro/config/components.env && podman pull ${REDIS_IMAGE}
  changed_when: false

- name: Generate SystemD unit
  template:
    src: systemd/redis.service.j2
    dest: /etc/systemd/system/redis.service
    mode: '0640'
  notify:
    - reconfigure systemd
    - restart redis

- name: Render configs
  template:
    src: "redis/redis.conf.j2"
    dest: "{{ redis_path_to_config }}"
    group: "{{ redis_group }}"
    mode: '0640'
  notify:
    - restart redis

- name: Do daemon-reload & restart service if need
  meta: flush_handlers

- name: Start and enable service
  systemd:
    name: redis
    state: started
    enabled: true

- name: Install logrorate config
  template:
    src: logrotate/redis.j2
    dest: /etc/logrotate.d/redis
    mode: '0644'
