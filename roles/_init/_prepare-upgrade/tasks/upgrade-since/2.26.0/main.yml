- name: Remove old packages
  package:
    name: [sendmail, sendmail-cf, ntp]
    state: absent

- name: Copy old files to the new location
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    remote_src: true
    mode: '0644'
  failed_when: false
  with_items:
    - src: /etc/nginx/ssl/cert.pem
      dest: "{{ ssl_cert_path }}"
    - src: /etc/nginx/ssl/privkey.pem
      dest: "{{ ssl_privkey_path }}"
    - src: /etc/ssl/certs/dhparam.pem
      dest: "{{ ssl_dhparam_path }}"
    - src: /etc/nginx/conf.d/vhosts.conf
      dest: /etc/nginx/conf.d/keitaro.conf

- name: Remove old files
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /etc/nginx/ssl/cert.pem
    - /etc/nginx/ssl/privkey.pem
    - /etc/ssl/certs/dhparam.pem
    - "{{ keitaro_app_dir }}/install.php"
    - /etc/logrotate.d/mariadb
    - /etc/keitaro/roadrunner.yml
    - /etc/sudoers.d/10-enable-ssl-command
    - /root/hosts.txt
    - /root/install.log
    - /root/enable-ssl.log
    - /root/add-site.log
    - /etc/nginx/conf.d/vhosts.conf
    - /etc/my.cnf.d/mysqld-error_log.cnf
    - /etc/my.cnf.d/mysqld-log_slow_queries.cnf
    - /etc/my.cnf.d/mysqld-optimize_performance.cnf
    - /etc/my.cnf.d/mysqld-set_pidfile_path.cnf
    - /etc/my.cnf.d/mysqld.cnf
    - /etc/my.cnf.d/keitaro-mysqld-set_default_storage_engine.cnf

- name: Remove all cron tasks of nginx user
  command: "crontab -r -u {{ nginx_user }}"
  register: remove_all_nginx_cron_tasks_result
  failed_when: false
  changed_when: remove_all_nginx_cron_tasks_result.rc == 0

- name: Remove old root tasks
  lineinfile:
    path: /var/spool/cron/root
    regexp: "{{ item }}"
    state: absent
  with_items:
    - cron.php
    - certbot renew

- name: Remove single channel keitaro cron task
  cron:
    user: "{{ keitaro_user }}"
    name: "keitaro"
    state: absent

- name: Remove old kctl tools links
  file:
    path: "/usr/bin/kctl-{{ item }}"
    state: absent
  with_items:
    - install
    - enable-ssl
    - disable-ssl
    - add-site
    - fail2ban
    - prune-ssl
