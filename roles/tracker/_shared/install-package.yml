- name: Set default tracker_package_url from tracker_version_to_install was set
  set_fact:
    tracker_package_url: "{{ keitaro_files }}/keitaro/releases/{{ tracker_version_to_install }}/package8.zip"
  when: (tracker_package_url is undefined) and (tracker_version_to_install is defined)

- name: Download and unarchive tracker package
  unarchive:
    src: "{{ tracker_package_url }}"
    dest: "{{ keitaro_app_dir }}"
    remote_src: true
  changed_when: false
  become_user: "{{ keitaro_user }}"

- name: Set unpacked_tracker_dir
  set_fact:
    unpacked_tracker_dir: "{{ keitaro_app_dir }}/www"

- name: Update tracker application dir with new files
  synchronize:
    src: "{{ unpacked_tracker_dir }}/"
    dest: "{{ keitaro_app_dir }}/"
    rsync_opts: '--quiet'
  delegate_to: "{{ inventory_hostname }}"
  become_user: "{{ keitaro_user }}"
  notify:
    - restart php-fpm
    - restart roadrunner

- name: Delete old files from updated tracker
  synchronize:
    src: "{{ unpacked_tracker_dir }}/{{ item }}/"
    dest: "{{ keitaro_app_dir }}/{{ item }}/"
    owner: true
    group: true
    delete: true
  with_items:
    - "application/Admin"
    - "application/Component"
    - "application/Core"
    - "application/Traffic"
    - "admin"
    - "bin"
    - "vendor"
  delegate_to: "{{ inventory_hostname }}"
  become_user: "{{ keitaro_user }}"
  notify:
    - restart php-fpm
    - restart roadrunner

- name: Delete unneded files
  file:
    path: "{{ unpacked_tracker_dir }}"
    state: absent
  changed_when: false
  notify:
    - restart php-fpm
    - restart roadrunner
