#!/usr/bin/env bash

RESPONSE_STATUSES_PATH=/var/log/nginx/status/access.log.1

responses() {
  local responses=""
  if [ -f ${RESPONSE_STATUSES_PATH} ]; then
    responses=$(sort ${RESPONSE_STATUSES_PATH} \
                | uniq -c \
                | awk '{print "\"" $2 "\":", $1 ", "}' \
                | sed '$ s/, $//g' \
                | tr -d "\n")
    responses="{${responses}}"
  else
    responses='null'
  fi
  echo $responses
}

cpu() {
  model_name="\"$(awk -F': ' '/^model name/ {print $2}' /proc/cpuinfo)\""
  frequency_mhz="$(awk -F': ' '/^cpu MHz/ {print $2}' /proc/cpuinfo)"
  cpu_cores="$(awk -F': ' '/^cpu cores/ {print $2}' /proc/cpuinfo)"
  echo "{model_name: ${model_name}, cpu_cores: ${cpu_cores}, frequency_mhz: ${frequency_mhz}}"
}

info() {
  uptime=$(awk '{print $1}' /proc/uptime | sed 's/\..*//g')
  load_1m="$(awk '{print $1}' /proc/loadavg)"
  load_5m="$(awk '{print $2}' /proc/loadavg)"
  load_15m="$(awk '{print $3}' /proc/loadavg)"
  load="{load: {\"1m\": ${load_1m}, \"5m\": ${load_5m}, \"15m\": ${load_15m}}}"
  timestamp="\"$(date --utc --iso-8601=seconds | sed 's/\+.*/Z/')\""
  echo "{uptime: ${uptime}, load: ${load}, timestamp: ${timestamp}}"
}

echo "{responses: $(responses), cpu: $(cpu), info: $(info)}"