- name: Clean CH logs
  changed_when: false
  shell: |
    [[ -f /etc/keitaro/config/tracker.env ]] && source /etc/keitaro/config/tracker.env

    if [[ "${CH_PASSWORD}" != "" ]]; then
      tables_sql="SELECT DISTINCT table FROM system.parts WHERE active AND table ILIKE '%_log'"

      tables="$(podman exec clickhouse clickhouse-client --password "${CH_PASSWORD}" -u keitaro -d system -q "${tables_sql}")"

      for table in ${tables}; do
        echo "Cleaning table ${table}"
        podman exec clickhouse clickhouse-client --password "${CH_PASSWORD}" -u keitaro -d system -q "TRUNCATE TABLE $table" || true
      done
    fi
    if [[ -d /var/log/clickhouse ]]; then
      rm -f /var/log/clickhouse/*.gz
      > /var/log/clickhouse/server.log
      > /var/log/clickhouse/err.log
    fi
