- name: Check if live folder exists
  stat:
    path: "/etc/letsencrypt/live/"
  register: le_live_folder

- name: Regenerate configs generated by enable-ssl
  when: le_live_folder.stat.exists
  block:
    - name: Detect configs genereated by old enable-ssl
      shell: >
        set -o pipefail \
          && (
            grep -l -v 'Generated by Keitaro install tool v1' *.conf \
            | grep -v '^keitaro\.conf$' \
            | sed 's/.conf$//g')
      args:
        chdir: /etc/nginx/conf.d
      register: enable_ssl_domains
      # grep will fail with 1 error code if there are no matches, so rc == 1 is ok
      failed_when: enable_ssl_domains.rc != 0 and enable_ssl_domains.rc != 1
      changed_when: false

    - name: Regenerate configs generated by enable-ssl
      shell: >
        set -o pipefail \
          && (
            export SKIP_RELOADING_NGINX=true SKIP_ISSUING_CERTIFICATE=true \
            && grep -l -v 'Generated by Keitaro install tool v1' *.conf \
            | grep -v '^keitaro\.conf$' \
            | sed 's/.conf$//g' \
            | xargs --max-args=1000 kctl certificates issue)
      args:
        chdir: /etc/nginx/conf.d
      when: enable_ssl_domains.stdout | length > 0
      notify:
        - reconfigure systemd
        - reload nginx

- name: Get unneeded nginx config files in /etc/nginx/conf.d directory
  find:
    paths: /etc/nginx/conf.d
    patterns:
      - '*.inc'
      - '*.conf.20*'
  register: obsolete_nginx_conf_d_files

- name: Get unneeded nginx config files in /etc/nginx/conf.d/keitaro directory
  find:
    paths: /etc/nginx/conf.d/keitaro
    patterns:
      - '*.local.inc'
      - 'tracker.engine.*'
      - 'tracker.realip.*'
  register: obsolete_nginx_conf_d_keitaro_files

- name: Remove unneeded nginx config files
  file:
    path: "{{ item.path }}"
    state: absent
  with_items: "{{ obsolete_nginx_conf_d_files.files + obsolete_nginx_conf_d_keitaro_files.files }}"

- name: Remove obsolete nginx local config dir
  file:
    path: /etc/nginx/conf.d/keitaro/local
    state: absent
