# Mixins
.docker:
  tags: [docker]

# Shared
image: apliteni/ruby-docker:latest

services:
  - postgres
  - docker:18.09-dind

variables:
  #DOCKER_TLS_CERTDIR: "/certs"
  #DOCKER_HOST: tcp://docker:2376

  RAILS_ENV: test
  POSTGRES_DB: test
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: ""
  DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/database_name"

default:
  cache:
    key: "$CI_BUILD_REF_NAME"
    paths:
      - /cache

  before_script:
    - ruby -v
    - docker info
    - which ruby
    #- gem install bundler --no-document
    - cd scripts/
    - bundle install

# Stages
stages:
  - quality_checks

# Jobs
run_rspec:
  image: apliteni/ruby-docker:latest

  extends: .docker
  stage: quality_checks
  script:
    - ci/bin/compile.sh
    - ci/bin/validate.sh
    - cd scripts/
    - bundle install
    - bundle exec rspec
  cache:
    paths:
      - /cache