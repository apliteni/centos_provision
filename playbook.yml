---
- hosts: all
  connection: "{{connection}}"
  become: yes
  become_method: sudo
  vars_files:
    - vars/keitaro.yml
    - vars/server.yml
    - vars/ssl.yml
    - vars/mariadb.yml
    - vars/nginx.yml
    - vars/php.yml
    - "vars/performance.{{ php_engine }}.yml"
    - vars/performance.yml

  roles:
    - {role: 'init/0-debug', tags: 'debug, tune, upgrade'}
    - {role: 'init/1-install', tags: 'prepare, upgrade'}
    - {role: 'init/2-upgrade', tags: 'never, upgrade'}
    - {role: 'mikegleasonjr.swap', tags: 'swap, upgrade'}
    - {role: 'geerlingguy.firewall', tags: 'firewall', when: "skip_firewall is not defined or skip_firewall != 'yes'"}
    - {role: 'resmo.ntp', tags: 'ntp'}
    - {role: 'mrlesmithjr.timezone'}
    - {role: 'geerlingguy.repo-remi', tags: 'repo-remi'}
    - {role: 'keitaro.systemd', tags: 'systemd, upgrade'}
    - {role: 'keitaro.disable_thp', tags: 'mariadb, tokudb, redis, upgrade'}
    - {role: 'keitaro.postfix', tags: 'mail, upgrade'}
    - {role: 'redis/1-install', tags: 'redis'}
    - {role: 'redis/2-tune', tags: 'redis, tune, redis-tune, upgrade'}
    - {role: 'mariadb/0-prepare-upgrade', tags: 'never, upgrade'}
    - {role: 'mariadb/1-install', tags: 'mariadb, upgrade'}
    - {role: 'mariadb/2-tokudb', tags: 'mariadb, tokudb, upgrade'}
    - {role: 'mariadb/3-tune', tags: 'mariadb, tokudb, tune, mariadb-tune, upgrade'}
    - {role: 'nginx/1-install', tags: 'nginx, upgrade'}
    - {role: 'nginx/2-tune', tags: 'nginx, tune, nginx-tune'}
    - {role: 'nginx/3-upgrade', tags: 'never, upgrade'}
    - {role: 'php/php/1-install', tags: 'php, upgrade'}
    - {role: 'php/php/2-tune', tags: 'php, upgrade'}
    - {role: 'php/php-fpm/1-install', tags: 'php, php-fpm, upgrade'}
    - {role: 'php/php-fpm/2-tune', tags: 'php, php-fpm, tune, php-fpm-tune, upgrade'}
    - {role: 'php/php-fpm/3-upgrade', tags: 'never, upgrade, php-fpm-upgrade'}
    - {role: 'php/roadrunner/1-install', tags: 'php, roadrunner, upgrade'}
    - {role: 'php/roadrunner/2-tune', tags: 'php, roadrunner, tune, roadrunner-tune, upgrade'}
    - {role: 'tracker/1-install', tags: 'tracker, tracker-install'}
    - {role: 'tracker/2-tune', tags: 'tracker, tune, tracker-tune, upgrade'}
    - {role: 'tracker/3-upgrade', tags: 'never, upgrade'}
    - {role: 'tracker/4-restore-db', tags: 'db_restore', when: "db_restore_path is defined and db_restore_path != ''"}

