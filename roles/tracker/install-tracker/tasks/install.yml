- name: Force all notified handlers to run at this point
  meta: flush_handlers

- include_tasks: "{{ playbook_dir }}/roles/common/get-tracker-info/latest_tracker.yml"
  vars:
    user_agent: "Keitaro Installer v{{ keitaro_installer_version }} PHP/{{ php_release }}"
    request_params: "version={{ keitaro_release }}&stability=unstable&phpversion={{ php_release }}"

- name: Download keitaro distribution
  include_tasks: "{{ playbook_dir }}/roles/common/download-tracker/keitaro_distribution.yml"

- name: Download install.php
  get_url:
    url: "{{ keitaro_install_php }}"
    dest: "{{ keitaro_app_dir }}/install.php"

- name: Import database .sql files
  shell: "mysql --user={{ db_user }} --password={{ db_password }} {{ db_name }} < {{ item }}"
  with_items:
    - "{{ keitaro_database_schema }}"
    - "{{ keitaro_database_data }}"
  when: "db_restore_path is undefined or db_restore_path == ''"

- name: Run install.php with args
  command: |
    {{ php_path }} install.php install \
                               --key={{ license_key }} \
                               --db-user="{{ db_user }}" \
                               --db-name="{{ db_name }}" \
                               --db-password="{{ db_password }}" \
                               --draft-storage=redis \
                               --cache-storage=files \
                               --force-tokudb \
                               --without-schema \
                               --without-geodbs
                               --without-admin
                               {{ language_option }} \
                               {{ kversion_option }} \
                               {{ custom_package_option }}
  vars:
    language_option: "{% if language is defined %}--language={{ language }}{% endif %}"
    kversion_option: "{% if kversion is defined %}--kversion={{ kversion }}{% endif %}"
    custom_package_option: "{% if custom_package is defined %}--custom-package={{ custom_package }}{% endif %}"
  args:
    chdir: "{{ keitaro_app_dir }}"
  become_user: "{{ keitaro_user }}"
  notify:
    - restart roadrunner

- name: Create keitaro admin
  command: "{{ php_path }} bin/cli.php admin:create {{ admin_login }} {{ admin_password }}"
  args:
    chdir: "{{ keitaro_app_dir }}"
  become_user: "{{ keitaro_user }}"
  when: "db_restore_path is undefined or db_restore_path == ''"

- name: Remove install.php
  file:
    path: "{{ keitaro_app_dir }}/install.php"
    state: absent

- name: Add IP to configi.ini.php resolve method
  lineinfile:
    path: "{{ keitaro_app_dir }}/application/config/config.ini.php"
    regexp: '^resolve_method'
    line: 'resolve_method = {{ license_ip }}'