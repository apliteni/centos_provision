- name: Force all notified handlers to run at this point
  meta: flush_handlers

- include_tasks: "{{ playbook_dir }}/roles/_common/get-tracker-info/latest_tracker.yml"
  vars:
    user_agent: "Keitaro Installer v{{ keitaro_installer_version }} PHP/{{ php_release }}"
    request_params: "version={{ keitaro_release }}&stability=unstable&phpversion={{ php_release }}"

- name: Download keitaro distribution
  include_tasks: "{{ playbook_dir }}/roles/_common/download-tracker/keitaro_distribution.yml"

- name: Download install.php
  get_url:
    url: "{{ keitaro_install_php }}"
    dest: "{{ keitaro_app_dir }}/install.php"

- name: Import database .sql files
  shell: "mysql --user={{ db_user }} --password={{ db_password }} {{ db_name }} < {{ item }}"
  with_items:
    - "{{ keitaro_database_schema }}"
    - "{{ keitaro_database_data }}"
  when: "db_restore_path is undefined or db_restore_path == ''"

- name: Run install.php with args
  command: |
    {{ php_path }} install.php install
                               --key={{ license_key }}
                               --ip={{ license_ip }}
                               --db-user={{ db_user }}
                               --db-name={{ db_name }}
                               --db-password={{ db_password }}
                               --draft-storage=redis
                               --cache-storage=files
                               --force-tokudb
                               --without-schema
                               --without-admin
                               --without-tracker
                               --language={{ language }}
  args:
    chdir: "{{ keitaro_app_dir }}"
  become_user: "{{ keitaro_user }}"
  notify:
    - restart roadrunner

- name: Create keitaro admin
  command: "{{ php_path }} bin/cli.php admin:create {{ admin_login }} {{ admin_password }}"
  args:
    chdir: "{{ keitaro_app_dir }}"
  become_user: "{{ keitaro_user }}"
  when: "db_restore_path is undefined or db_restore_path == ''"

- name: Remove install.php
  file:
    path: "{{ keitaro_app_dir }}/install.php"
    state: absent
