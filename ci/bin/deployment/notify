#!/usr/bin/env bash
set -e -x -o pipefail

if [ -z "$SLACK_WEBHOOK" ]
then
      echo "\$SLACK_WEBHOOK is empty";
      exit 1;
fi

s3_url="https://${S3_HOST}/${S3_BUCKET}/${DEPLOY_TO}";

if [[ ${DEPLOY_TO} == 'releases/current' ]]; then
  build_description="current release (based on ${RELEASE_VERSION})"
elif [[ ${DEPLOY_TO} == 'releases/stable' ]]; then
  build_description="release ${RELEASE_TAG}"
else
  build_description="${CI_COMMIT_REF_NAME} build (based on ${RELEASE_VERSION})"
fi

text="Installer ${build_description} is ready!"
text="${text}\nUse the following command to upgrade to this release"
text="${text}\n\`curl ${s3_url}/install.sh | bash -s -- -rt upgrade\`"

curl "${SLACK_WEBHOOK}" -X POST --data "{\"text\": \"${text}\"}" -H 'Content-type: application/json'
