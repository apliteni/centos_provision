- name: Update geo databases
  command: "{{ kctl_path }} run cli-php geodbs:update_all"
  changed_when: false

- name: Configure cron to run keitaro task every minute (4 channels)
  cron:
    user: "{{ keitaro_user }}"
    name: "keitaro cron (channel {{ item }})"
    job: "CHANNEL={{ item }} {{ kctl_php_path }} {{ keitaro_app_dir }}/cron.php > /dev/null"
  loop: [1, 2, 3, 4]

# weekly task
- name: Configure cron to update geo databases every week
  cron:
    user: "{{ keitaro_user }}"
    name: "update geodbs"
    weekday: "{{ box_creation_time | extract_weekday }}"
    hour: "{{ box_creation_time | extract_hour | next_hour }}"
    minute: "{{ box_creation_time | extract_minute | next_minute }}"
    job: "{{ kctl_php_path }} {{ keitaro_app_dir }}/bin/cli.php geodbs:update_all > /dev/null"

- name: Generate watch list if it doesn't exist.
  copy:
    dest: "{{ keitaro_watch_list }}"
    content: >
      application/redirects/
      application/macros/
      application/filters/
      application/config/config.ini.php
    force: false
    mode: '0644'
