#!/usr/bin/env bash
set -e -x -o pipefail

source ci/bin/lib/ensure_variables_are_set.sh

ensure_variables_are_set SLACK_WEBHOOK S3_HOST S3_BUCKET DEPLOY_TO RELEASE_VERSION CI_COMMIT_REF_NAME

s3_url="https://${S3_HOST}/${S3_BUCKET}/${DEPLOY_TO}";

if [[ ${DEPLOY_TO} == 'releases/current' ]]; then
  build_description="current release (based on ${RELEASE_VERSION})"
elif [[ ${DEPLOY_TO} == 'releases/stable' ]]; then
  build_description="release ${RELEASE_VERSION}"
else
  build_description="${CI_COMMIT_REF_NAME} build (based on ${RELEASE_VERSION})"
fi

text="Installer ${build_description} is ready!"
text="${text}\nUse the following command to upgrade to this release"
text="${text}\n\`curl ${s3_url}/install.sh | bash -s -- -rt upgrade\`"

curl "${SLACK_WEBHOOK}" -X POST --data "{\"text\": \"${text}\"}" -H 'Content-type: application/json'
