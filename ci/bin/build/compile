#!/usr/bin/env bash

source ci/bin/lib/ensure_variables_are_set.sh

ensure_variables_are_set SSH_PRIVATE_KEY RELEASE_VERSION

SCRIPTS_DIR="scripts"

echo "Set current release to $RELEASE_VERSION"
sed -i "s/^RELEASE_VERSION=.*/RELEASE_VERSION='$RELEASE_VERSION'/g" "${SCRIPTS_DIR}/src/shared/vars/common.sh"
cd ${SCRIPTS_DIR}

compile_template(){
  local script_template="${1}"
  local compiled_script="${2}"
  cp "${script_template}" "${compiled_script}"
  bin/postprocess_requires "${compiled_script}"
  chmod a+x "${compiled_script}"
}

compile_template src/installer.sh.tpl install.sh
compile_template src/ssl_enabler.sh.tpl enable-ssl.sh
compile_template src/site_adder.sh.tpl add-site.sh
compile_template src/run_command_tester.sh.tpl test-run-command.sh

echo -e "\e[32mCompile $RELEASE_VERSION version complete"
