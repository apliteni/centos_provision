# Generated by Keitaro install tool v{{ installer_version }}

server {
  server_name _;

  listen 80 default_server;

  listen 443 ssl;
  ssl_certificate {{ ssl_cert_path }};
  ssl_certificate_key {{ ssl_privkey_path }};
  ssl_session_cache   shared:SSL:10m;
  ssl_session_timeout 10m;
  ssl_prefer_server_ciphers on;
  ssl_dhparam {{ ssl_dhparam_path }};
  add_header X-Content-Type-Options nosniff;

  root {{ keitaro_root }};

  index index.php index.html;

  {{ nginx_keitaro_access_log_entry }};
  {{ nginx_keitaro_status_log_entry }};

  location ~* \.(jpg|jpeg|gif|png|js|css|txt|zip|ico|gz|csv)$ {
    {{ nginx_keitaro_access_log_entry }};

    expires 10d;
  }

  location ~ /\.(?!well-known/).* {
    access_log off;
    return 404;
  }

  location /.well-known/ {
    allow all;
  }

  location ~ ^/(var|lib|application)/.* {
    access_log off;
    return 404;
  }

  location = /admin {
     return 301 /admin/;
  }

  location /admin/ {
    {{ nginx_keitaro_admin_access_log_entry }};
    {{ nginx_keitaro_status_log_entry }};

    include {{ nginx_conf_path }}/keitaro-nontracker.php-fpm.inc;
  }

  location ~ \.php$ {
    try_files $uri =404;

    include {{ nginx_conf_path }}/keitaro.nontracker.php-fpm.inc;
  }

  location = /status {
    access_log off;
    allow 127.0.0.1;
    deny all;
    include {{ nginx_conf_path }}/keitaro-tracker.php-fpm.inc;
  }

  location ~ ^/(index.php|api.php)$ {
    include {{ nginx_conf_path }}/keitaro.tracker.inc;
  }

  location / {
    try_files $uri $uri/ /index.php$is_args$args;
  }
}
