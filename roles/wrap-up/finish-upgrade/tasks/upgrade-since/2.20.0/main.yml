- name: Get php-fpm SystemD units
  shell: >
    set -o pipefail && \
      systemctl list-unit-files | \
      grep -P 'php\d+-php-fpm\.service' | \
      grep -v '{{ php_version }}-php-fpm.service' | \
      awk -F. '{print $1}'
  register: get_unneeded_php_fpm_services
  # grep will fail with 1 error code if there are no matches, so rc == 1 is ok
  failed_when: get_unneeded_php_fpm_services.rc != 0 and get_unneeded_php_fpm_services.rc != 1
  changed_when: false

- name: Remove old php-fpm
  package:
    name: "{{ item }}"
    state: absent
  with_items: "{{ get_unneeded_php_fpm_services.stdout_lines }}"
