- name: Set mariadb_user_id
  set_fact:
    mariadb_user_id: "{{ mariadb_user_info.uid }}"
    mariadb_group_id: "{{ mariadb_user_info.group }}"

- name: Set podman command for Centos 7
  set_fact:
    podman_command: "/usr/bin/podman rm --force {{ mariadb_docker_name }} && /usr/bin/podman rm --force --storage {{ mariadb_docker_name }}"
  when: ansible_distribution_major_version | int == 7

- name: Set podman command for Centos above 7
  set_fact:
    podman_command: "/usr/bin/podman rm --force --storage {{ mariadb_docker_name }}"
  when: ansible_distribution_major_version | int > 7

- name: Pull image
  shell: source /etc/keitaro/config/components.env && podman pull ${MARIADB_IMAGE}
  changed_when: false

- name: Generate systemd mariadb config
  template:
    src: systemd/mariadb.service.j2
    dest: /etc/systemd/system/mariadb.service
    mode: '0640'
  notify:
    - reconfigure systemd
    - restart mariadb

- name: Render configs
  template:
    src: "my.cnf.j2"
    dest: "{{ mariadb_path_to_config }}"
    group: "{{ mariadb_group }}"
    mode: '0640'
  notify: restart mariadb

- name: Do daemon-reload & restart service if need
  meta: flush_handlers

- name: Start and enable service
  service:
    name: mariadb
    state: started
    enabled: true

- name: Generate logrotate config
  template:
    src: "mariadb-logrotate.j2"
    dest: "/etc/logrotate.d/mysql"
    mode: '0644'
