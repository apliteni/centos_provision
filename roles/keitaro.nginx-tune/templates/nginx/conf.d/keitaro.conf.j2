# Generated by Keitaro install tool v{{ installer_version }}

server {
  server_name _;

  listen 80 default_server;

  listen 443 ssl;
  ssl_certificate {{ ssl_cert_path }};
  ssl_certificate_key {{ ssl_privkey_path }};
  ssl_session_cache   shared:SSL:10m;
  ssl_session_timeout 10m;
  ssl_prefer_server_ciphers on;
  ssl_dhparam {{ ssl_dhparam_path }};
  add_header X-Content-Type-Options nosniff;

  root {{ keitaro_root }};

  index index.php index.html;

  {{ nginx_keitaro_access_log_entry }};

  # Hide hidden locations
  location ~ /\..* {
    access_log off;
    return 404;

    # Except LE locations
    location ~ /\.well-known/ {
      allow all;
    }
  }

  # Status page

  location = /status {
    access_log off;
    allow 127.0.0.1;
    deny all;
    include {{ nginx_conf_path }}/keitaro-tracker.php-fpm.inc;
  }

  # Landings & other PHP scripts

  location ~* \.(jpg|jpeg|gif|png|js|css|txt|zip|ico|gz|csv|svg|ttf)$ {
    access_log off;
    expires 10d;
  }

  location ~ \.php$ {
    {{ nginx_keitaro_access_log_entry }};
    {{ nginx_keitaro_status_log_entry }};

    try_files $uri =404;

    include {{ nginx_conf_path }}/keitaro-nontracker.inc;
  }

  # Admin locations

  location /admin/assets/ {
    access_log off;
  }

  location = /admin/index.php {
    {{ nginx_keitaro_admin_access_log_entry }};
    {{ nginx_keitaro_status_log_entry }};

    include {{ nginx_conf_path }}/keitaro-nontracker.inc;
  }

  location = /admin {
     return 301 /admin/;
  }

  location /admin/ {
    try_files $uri /admin/index.php$is_args$args;
  }

  # Tracker locations

  location ~ ^/(var|lib|application)/.* {
    access_log off;
    return 404;
  }

  location = /api.php {
    {{ nginx_keitaro_access_log_entry }};
    {{ nginx_keitaro_status_log_entry }};

    include {{ nginx_conf_path }}/keitaro-tracker.inc;
  }

  location = /index.php {
    {{ nginx_keitaro_access_log_entry }};
    {{ nginx_keitaro_status_log_entry }};

    include {{ nginx_conf_path }}/keitaro-tracker.inc;
  }

  location / {
    try_files $uri $uri/ /index.php$is_args$args;
  }
}
