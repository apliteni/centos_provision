- name: Detect configs genereated by add-site
  shell: >
    grep -w root $(grep -l 'Keitaro add-site' *.conf) | \
      grep -v '/var/www/keitaro;' | \
      awk -F: '{print $1}' | \
      sed 's/.conf$//g'
  args:
    chdir: /etc/nginx/conf.d
  register: add_site_domains
  changed_when: false

- name: Check if live folder exists
  stat:
    path: "/etc/letsencrypt/live/"
  register: le_live_folder

- block:
    - name: Detect configs genereated by enable-ssl
      shell: >
        grep -l /etc/letsencrypt/live/ $(grep -l 'root {{ keitaro_app_dir }}' *.conf) | \
          sed 's/.conf$//g' | \
          tr '\n' ',' | \
          sed 's/,$//g'
      args:
        chdir: /etc/nginx/conf.d
      register: enable_ssl_domains
      changed_when: false

    - name: Regenerate configs generated by enable-ssl
      shell: "{{ kctl_bin_dir }}/kctl-enable-ssl -f -D {{ enable_ssl_domains.stdout }}"
      when: enable_ssl_domains.stdout | length > 0
      notify:
        - reload nginx

  when: le_live_folder.stat.exists

- name: Regenerate configs generated by add-site
  shell: >
    SITE_ROOT=$(grep -w root /etc/nginx/conf.d/{{ item }}.conf | awk '{print $2}' | sed 's/;//')
    {{ kctl_bin_dir }}/kctl-add-site -f -D {{ item }} -R "${SITE_ROOT}"
  with_items: "{{ add_site_domains.stdout_lines }}"
  notify:
    - reload nginx

- name: Get unneeded nginx config files in /etc/nginx/conf.d directory
  find:
    paths: /etc/nginx/conf.d
    patterns:
      - '*.inc'
      - '*.conf.20*'
  register: obsolete_nginx_conf_d_files

- name: Get unneeded nginx config files in /etc/nginx/conf.d/keitaro directory
  find:
    paths: /etc/nginx/conf.d/keitaro
    patterns:
      - '*.local.inc'
      - 'tracker.engine.*'
      - 'tracker.realip.*'
  register: obsolete_nginx_conf_d_keitaro_files

- name: Remove unneeded nginx config files
  file:
    path: "{{ item.path }}"
    state: absent
  with_items: "{{ obsolete_nginx_conf_d_files.files + obsolete_nginx_conf_d_keitaro_files.files }}"

- name: Remove obsolete nginx local config dir
  file:
    path: /etc/nginx/conf.d/keitaro/local
    state: absent
