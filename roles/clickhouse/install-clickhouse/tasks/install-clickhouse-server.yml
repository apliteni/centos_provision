- name: Set clickhouse_uid
  set_fact:
    clickhouse_user_uid: "{{ clickhouse_user.uid }}"

- name: Pull clickhouse image
  containers.podman.podman_image:
    name: "{{ clickhouse_docker_image }}"

- name: Make additional config dirs
  file:
    dest: "{{ clickhouse_config_path }}/{{ item }}"
    mode: '0755'
    state: directory
  with_items:
    - "config.d"
    - "users.d"

- name: Render clickhouse configs
  template:
    src: "configs/{{ item }}.j2"
    dest: "{{ clickhouse_config_path }}/{{ item }}"
    mode: '0644'
  with_items:
    - "users.xml"
    - "config.xml"
  notify:
    - restart clickhouse

- name: Generate systemd clickhouse config
  template:
    src: "clickhouse-server.service.j2"
    dest: /etc/systemd/system/clickhouse.service
    mode: '0644'
  notify:
    - reconfigure systemd
    - restart clickhouse

- name: Do daemon-reload to update SystemD services & restart clickhouse if need
  meta: flush_handlers

- name: Enable CH
  service:
    name: clickhouse
    enabled: true
