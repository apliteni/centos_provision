- name: Clean CH logs
  changed_when: false
  shell: |
    set -o pipefail

    [[ -f /etc/keitaro/config/tracker.env ]] && source /etc/keitaro/config/tracker.env

    if [[ -f /etc/clickhouse/config.xml ]]; then
      systemctl start clickhouse
      sleep 10
    fi

    if [[ -f /etc/clickhouse/config.xml ]] && [[ "${CH_PASSWORD}" != "" ]]; then
      tables_sql="SELECT DISTINCT table FROM system.parts WHERE active AND (table ILIKE '%_log' OR table ILIKE '%_log_%')"

      tables="$(podman exec clickhouse clickhouse-client --password "${CH_PASSWORD}" -u keitaro -d system -q "${tables_sql}")"

      for table in ${tables}; do
        echo "Cleaning table ${table}"
        podman exec clickhouse clickhouse-client --password "${CH_PASSWORD}" -u keitaro -d system -q "TRUNCATE TABLE $table" || true
      done

      for table in query_log trace_log metric_log asynchronous_metric_log; do
        echo "Cleaning table ${table}"
        podman exec clickhouse clickhouse-client --password "${CH_PASSWORD}" -u keitaro -d system -q "TRUNCATE TABLE $table" || true
      done
    fi
    if [[ -d /var/log/clickhouse ]]; then
      rm -f /var/log/clickhouse/*
    fi
