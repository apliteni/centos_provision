- name: Converge
  hosts: all
  become: yes
  become_method: sudo
  tasks:
    - set_fact:
        scenario_converge_tasks_path: "{{ lookup('env', 'MOLECULE_SCENARIO_DIRECTORY') + '/converge-tasks.yml' }}"
        current_role_name: "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') | basename }}"

    - include_role:
        name: _init/_init

    - name: Redefine handlers
      include_role:
        name: redefine_handlers

    - name: Check if converge-tasks.yml is present
      local_action:
        module: stat
        path: "{{ scenario_converge_tasks_path }}"
      become: no
      register: scenario_converge_tasks_info

    - debug:
        msg: "Including {{ scenario_converge_tasks_path }}"
      when: scenario_converge_tasks_info.stat.exists | default(false)

    - include: "{{ scenario_converge_tasks_path }}"
      when: scenario_converge_tasks_info.stat.exists | default(false)

    - debug:
        msg: "Including role '{{ current_role_name }}'"

    - include_role:
        name: "{{ current_role_name }}"
