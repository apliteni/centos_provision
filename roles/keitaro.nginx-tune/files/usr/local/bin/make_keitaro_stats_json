#!/usr/bin/env bash

RESPONSE_STATUSES_PATH=/var/log/nginx/status/access.log.1
if [ -f ${RESPONSE_STATUSES_PATH} ]; then
  responses=$(sort ${RESPONSE_STATUSES_PATH} \
              | uniq -c \
              | awk '{print "\"" $2 "\":", $1 ", "}' \
              | sed '$ s/, $//g' \
              | tr -d "\n")
  responses="{${responses}}"
else
  responses='null'
fi

cpu='null'
ssd='null'

uptime=$(awk '{print $1}' /proc/uptime | sed 's/\..*//g')
timestamp="\"$(date --utc --iso-8601=seconds)\""

echo "{responses: ${responses}, cpu: ${cpu}, ssd: ${ssd}, uptime: ${uptime}, timestamp: ${timestamp}}"