#!/bin/bash

COMMAND=${1}
RR_PIDFILE={{ rr_pidfile }}
RR_CONFIG={{ rr_config }}
RR_BIN={{ rr_bin }}
JID_LENGTH=5
WATCHDOG_USEC="${WATCHDOG_USEC:-60000000}" # Set default watchdog interval to 60 secs
WATCH_INTERVAL=$((${WATCHDOG_USEC} / 1000000 / 2)) # We will notify watchdog every half of WATCHDOG_USEC

print_err() {
  local err="${1}"
  (>&2 echo "${err}")
}

keitaro_log() {
  local level="${1}"
  local message="${2}"
  local jid="$(generate_jid)"
  local date="$(date +"%F" -u)"
  local time="$(date +"%T" -u)"
  log_line="[${date} ${time}] [${level}] (jid:${jid}) [\"systemd\"] : RoadRunner: ${message}"
  sudo -u keitaro bash -c "echo '${log_line}' >> {{ keitaro_root }}/var/log/production-${date}.log"
}

log_and_print_err() {
  local level="${1}"
  local message="${2}"
  print_err "${level} ${message}"
  keitaro_log "${level}" "${message}"
}

usage() {
  print_err "Usage: keitaro-roadrunner COMMAND"
}

rr_cmd() {
  local cmd=${1}
  echo "[INFO] Run command ${RR_BIN} ${cmd} -v -d -c ${RR_CONFIG}"
  ${RR_BIN} ${cmd} -v -d -l plain -c ${RR_CONFIG}
}

generate_jid() {
  LC_ALL=C tr -cd '[:alnum:]' < /dev/urandom | head -c${JID_LENGTH}
}

init_watchdog() {
  echo "[INFO] Initializing SystemD watchdog"
  /bin/systemd-notify --ready
}

notify_watchdog() {
  echo "[INFO] Notify SystemD watchdog that RoadRunner is alive"
  /bin/systemd-notify WATCHDOG=1
}

is_alive() {
  local pid="${1}"
  kill -0 ${pid} 2>/dev/null
}

wait_for_next_tick() {
  echo "[INFO] Sleeping for ${WATCH_INTERVAL} sec"
  sleep ${WATCH_INTERVAL}
}

watch_daemon() {
  local daemon_pid="${1}"
  local error=""

  init_watchdog

  while(true); do

    if ! is_alive ${daemon_pid}; then
      log_and_print_err "WARNING" "Process ${daemon_pid} gone."
    elif ! workers | grep -q '.'; then
      log_and_print_err "WARNING" "There are no php workers found."
    else
      notify_watchdog
    fi

    wait_for_next_tick
  done
}

start() {
    trap 'kill $(jobs -p) 2>/dev/null' EXIT

    rr_cmd serve &
    local daemon_pid=$!

    watch_daemon ${daemon_pid}
}

stop() {
  rr_cmd stop
}

reload() {
  rr_cmd http:reset
}

workers() {
  rr_cmd http:workers | tail -n +4 | head -n -1
}

if [[ "$#" != "1" ]]; then
  usage
  exit 1
fi

case ${1} in
  start)
    start
    ;;
  stop)
    stop
    ;;
  reload)
    reload
    ;;
  workers)
    workers
    ;;
  *)
    usage
    exit 1
    ;;
esac
