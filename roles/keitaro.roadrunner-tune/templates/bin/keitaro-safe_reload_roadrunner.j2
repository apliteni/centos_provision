#!/bin/bash
NEED_TO_RELOAD=/var/run/roadrunner-need-to-reload
RELOADING_LOCK=/var/run/roadrunner-reloading.lock
RELOADING_CMD="rm -f ${NEED_TO_RELOAD} && /usr/bin/systemctl reload roadrunner"
SLEEP_TIME_IN_SEC=1
WAIT_FOR_FREEING_LOCK=5

file_age_in_msec() {
  local file="${1}"
  echo $(($(date +%s%3N) - $(date +%s%3N -r "${file}")))
}

echo "Touching ${NEED_TO_RELOAD}"
touch ${NEED_TO_RELOAD}

echo "Sleeping for ${SLEEP_TIME_IN_SEC} seconds"
sleep ${SLEEP_TIME_IN_SEC}s


if [[ -f ${NEED_TO_RELOAD} ]]; then
  if (( $(file_age_in_msec "${NEED_TO_RELOAD}") > ${SLEEP_TIME_IN_SEC}*1000 )); then
    echo "Reloading roadrunner"
    /usr/bin/flock -w ${WAIT_FOR_FREEING_LOCK} ${RELOADING_LOCK} /bin/bash -c "${RELOADING_CMD}" \
        echo "Reloaded" || \
        echo "Reloading skipped"
    exit
  fi
fi
echo "Skip reloading roadrunner (another process should do this)"
