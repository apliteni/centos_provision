- name: Detect configs genereated by add-site
  shell: >
    grep -w root $(grep -l 'Keitaro add-site' *.conf) | \
      grep -v '/var/www/keitaro;' | \
      awk -F: '{print $1}' | \
      sed 's/.conf$//g'
  args:
    chdir: /etc/nginx/conf.d/
  register: add_site_domains
  check_mode: no

- name: Detect configs genereated by enable-ssl
  shell: >
    grep -l /etc/letsencrypt/live/ $(grep -l 'root {{ keitaro_app_dir }}' *.conf) | \
      sed 's/.conf$//g' | \
      tr '\n' ',' | \
      sed 's/,$//g'
  args:
    chdir: /etc/nginx/conf.d/
  register: enable_ssl_domains
  check_mode: no

- name: Regenerate configs generated by add-site
  shell: >
    SITE_ROOT=$(grep -w root /etc/nginx/conf.d/{{ item }}.conf | awk '{print $2}' | sed 's/;//')
    {{ kctl_bin_dir }}/kctl-add-site -f -D {{ item }} -R "${SITE_ROOT}"
  with_items: "{{ add_site_domains.stdout_lines }}"
  notify:
    - reload nginx

- name: Regenerate configs generated by enable-ssl
  shell: "{{ kctl_bin_dir }}/kctl-enable-ssl -f -D {{ enable_ssl_domains.stdout }}"
  when: enable_ssl_domains.stdout != ""
  notify:
    - reload nginx

- name: Remove old nginx files
  shell: >
    rm -rf /etc/nginx/conf.d/keitaro-*.inc \
          /etc/nginx/conf.d/*.inc \
          /etc/nginx/conf.d/keitaro/*.local.inc \
          /etc/nginx/conf.d/keitaro/local \
          /etc/nginx/conf.d/keitaro/tracker.engine.* \
          /etc/nginx/conf.d/keitaro/tracker.realip.*
  notify:
    - reload nginx

- name: Remove old backup nginx host files
  shell: "rm -f /etc/nginx/conf.d/*.conf.20*"

