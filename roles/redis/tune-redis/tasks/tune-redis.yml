- name: Set redis config file
  set_fact:
    redis_config: "/etc/redis/redis.conf"
  when: centos_release_version == "9"
- name: Tune redis tcp-backlog
  lineinfile:
    dest: "{{ redis_config }}"
    regexp: '^tcp-backlog \d+'
    line: 'tcp-backlog 65535'
  notify: restart redis

- name: Set memory limit
  lineinfile:
    path: "{{ redis_config }}"
    insertafter: '^# maxmemory '
    regexp: '^maxmemory '
    line: 'maxmemory {{ redis_memory_mb }}mb'
  notify: restart redis

- name: Set maxmemory policy
  lineinfile:
    path: "{{ redis_config }}"
    insertafter: '^# maxmemory-policy '
    regexp: '^maxmemory-policy '
    line: 'maxmemory-policy volatile-ttl'
  notify: restart redis
