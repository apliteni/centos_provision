- name: Set clickhouse_uid
  set_fact:
    clickhouse_user_id: "{{ clickhouse_user_info.uid }}"
    clickhouse_group_id: "{{ clickhouse_user_info.group }}"

- name: Set podman command for Centos 7
  set_fact:
    podman_command: "/usr/bin/podman rm --force {{ clickhouse_docker_name }} && /usr/bin/podman rm --force --storage {{ clickhouse_docker_name }}"
  when: ansible_distribution_major_version | int == 7

- name: Set podman command for Centos above 7
  set_fact:
    podman_command: "/usr/bin/podman rm --force --storage {{ clickhouse_docker_name }}"
  when: ansible_distribution_major_version | int > 7

- name: Pull image
  shell: source /etc/keitaro/config/components.env && podman pull ${CLICKHOUSE_IMAGE}
  changed_when: false

- name: Generate SystemD unit
  template:
    src: clickhouse.service.j2
    dest: /etc/systemd/system/clickhouse.service
    mode: '0640'
  notify:
    - reconfigure systemd
    - restart clickhouse

- name: Render configs
  template:
    src: "configs/{{ item }}.j2"
    dest: "{{ clickhouse_path_to_configs }}/{{ item }}"
    owner: "{{ clickhouse_user }}"
    group: "{{ clickhouse_group }}"
    mode: '0640'
  with_items:
    - "users.xml"
    - "config.xml"
  notify:
    - restart clickhouse

- name: Do daemon-reload & restart service if need
  meta: flush_handlers

- name: Start and enable service
  service:
    name: clickhouse
    state: started
    enabled: true
