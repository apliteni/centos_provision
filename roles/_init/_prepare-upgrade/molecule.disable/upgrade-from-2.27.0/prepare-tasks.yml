- include_role:
    name: _init/create-user-and-dirs

- copy:
   dest: "{{ keitaro_app_dir }}/version.php"
   content: "<?php return '9.12.12';"

- name: Create necessary directories
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - /etc/nginx/conf.d
    - /etc/my.cnf.d
    - /opt/eff.org
    - /usr/local/bin

- name: Create old files
  file:
    path: "{{ item }}"
    state: touch
  with_items:
    - /opt/eff.org/certbot
    - /usr/local/bin/certbot
    - /etc/my.cnf.d/keitaro-mysqld-error_log.cnf
    - /etc/my.cnf.d/network.cnf

- name: Disable IPv6 in kernel
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
  with_dict:
    net.ipv6.conf.all.disable_ipv6: 1
    net.ipv6.conf.default.disable_ipv6: 1

- name: Generate ipv4 /etc/nginx/conf.d/keitaro.conf
  copy:
    dest: /etc/nginx/conf.d/keitaro.conf
    content: |
      # Generated by Keitaro install tool v2.26.0
      server {
        server_name _;

        listen 80 default_server;

        listen 443 ssl;
        ssl_certificate /etc/keitaro/ssl/cert.pem;
      }

- name: Generate ipv4 /etc/nginx/conf.d/not_a_keitaro.conf
  copy:
    dest: /etc/nginx/conf.d/not_a_keitaro.conf
    content: |
      server {
        server_name some.domain.com;

        listen 80;

        listen 443 ssl;
      }

- name: Generate ipv6 /etc/nginx/conf.d/keitaro_ipv6.conf
  copy:
    dest: /etc/nginx/conf.d/keitaro_ipv6.conf
    content: |
      # Generated by Keitaro install tool v2.26.0

      server {
        server_name someipv6.domain.com;

        listen 80;
        listen [::]:80;

        listen 443 ssl;
        listen [::]:443 ssl;
      }

- name: Make podman stub
  shell: cp /bin/true /usr/bin/podman
