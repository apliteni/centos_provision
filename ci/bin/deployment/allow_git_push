#!/usr/bin/env bash
set -e -x -o pipefail

if [ -z "$SSH_DEPLOY_KEY" ]
then
      echo "\$SSH_DEPLOY_KEY is empty";
      exit 1;
fi

echo "${SSH_DEPLOY_KEY}" > "${HOME}/.ssh/id_rsa"
chmod 600 "${HOME}/.ssh/id_rsa"

git config user.name "${GITLAB_USER_NAME}" --replace-all
git config user.email "${GITLAB_USER_EMAIL}" --replace-all

repo=$(echo "$CI_REPOSITORY_URL" | perl -pe 's#.*@(.+?(\:\d+)?)/#git@\1:#')

git remote set-url origin "${repo}"
